<html>
<head>
<script src="http://code.jquery.com/jquery-1.8.0.min.js"></script>
<script src="game.json"></script>
<script>
function readGameJson(url, callback)
{
	/*
	$.ajax({
	  url: url,
	  dataType: 'json',
	  success: function(result){
	    //alert("token recieved: " + result.token);
	    callback(result);
	  },
	  error: function(request, textStatus, errorThrown) {
	    alert(textStatus);
	  },
	  complete: function(request, textStatus) { //for additional info
	    //alert(request.responseText);
	    //alert(textStatus);
	  }
	});
*/
	callback(json);
	//alert(json.length);
}

function print(ch)
{
	var box = $("textarea#chatBox");
	box.val(box.val() + String(ch));
	//alert(box.value);
	//var chrStr = String(ch);
	//alert(chrStr);
	//box.value = box.value + chrStr;
	//alert(box.value);
}

var currNode;

var lines;
var currLineIndex;
var currLineCharIndex;

var charDelayInMs = 40;
var lineDelayInMs = 1250;
var choiceDelayInMs = 800;

function resetLines()
{
	currLineCharIndex = 0;
	currLineIndex = 0;
	lines = [];
}

var displayLinesCallback;

function displayLines()
{
	//alert(currLineIndex);
	var line = lines[currLineIndex];
	var ch = line.charAt(currLineCharIndex++);
	//alert(line);
	//alert(ch);
	print(ch);
	if (currLineCharIndex < line.length)
	{
		// loop through this line's characters
		setTimeout(displayLines, charDelayInMs);
	}
	else
	{
		// end of line
		print('\n');
		currLineCharIndex = 0;
		currLineIndex++;
		if (currLineIndex < lines.length)
		{
			setTimeout(displayLines, lineDelayInMs);
		}
		else
		{
			//displayLinesCallback();
			setTimeout(displayLinesCallback, lineDelayInMs);
		}
	}
}

function getUserInput()
{
	alert('done');
}

var buttons;
var buttonIndex;

function showButtons()
{
	if (buttonIndex < buttons.length)
	{
		buttons[buttonIndex++].show();
		setTimeout(showButtons, choiceDelayInMs);
	}
}

function hideButtons()
{

	for (var i=0; i < buttons.length; i++) {
		buttons[i].hide();
	}
}

function displayChoices()
{
	if (currNode.nextnode != null)
	{
		alert(currNode.nextnode);
		var node = findNode(currNode.nextnode);
		displayNode(node);
	}
	else
	{
		buttons = [ $("#c0"), $("#c1"), $("#c2") ];
		buttonIndex = 0;
		showButtons();
	}
}

function loadChoices(node)
{
	for (var i=0; i < node.choices.length; i++)
	{
		buttons[i].html(node.choices[i].text);
	}
}

function findNode(nodename)
{
	for (var i=0; i < jsonData.length; i++)
	{
		if (jsonData[i].nodename == nodename)
		{
			return jsonData[i];
		}
	}
	return null;
}

function choiceClicked(index)
{
	var node;
	//var index = button.value;
	var nextNodeName = currNode.choices[index].nodename;
	node = findNode(nextNodeName);
	if (node != null)
	{
		displayNode(node);
	}
}

function displayNode(node)
{
	hideButtons();
	currNode = node;
	loadChoices(currNode);
	
	resetLines();
	lines = node.lines;
	displayLinesCallback = displayChoices;
	
	displayLines();
}

var jsonData;

$(document).ready(function() {

	buttons = [ $("#c0"), $("#c1"), $("#c2") ];
	
	readGameJson("game.json", function(data) {
		jsonData = data;
		displayNode(data[0]);
	});
});

</script>
</head>
<body>
<h1>Chattr Client</h1>
<h2>Msg from DefinitelyNotABot1337</h2>
<textarea rows="30" cols="80" id="chatBox"></textarea>
<div id="buttonDiv">
<button id="c0" onClick="choiceClicked(0);"></button>
<button id="c1" onClick="choiceClicked(1);"></button>
<button id="c2" onClick="choiceClicked(2);"></button>
</div>
</body>
</html>